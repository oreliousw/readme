// © Mr O
//@version=6
strategy("T7 Checklist Aligned Strategy v1.0", overlay=true, shorttitle="T7 Strat", default_qty_type=strategy.percent_of_equity, default_qty_value=10, initial_capital=10000)

//──────────────────────────────────────────────
// ✳️ INPUTS
//──────────────────────────────────────────────
smaLen       = input.int(20, "SMA Length (Trend)")
volLen       = input.int(20, "Volume SMA Length")
rsiLen       = input.int(14, "RSI Length")
maxVolMult   = input.float(1.3, "Max Volume Multiple (Steady Vol)")
rangeLen     = input.int(10, "Range Smoothing")
use4HFilter  = input.bool(true, "Use 4H Bias Filter?")
use1HConfirm = input.bool(true, "Use 1H Confirmation?")
showEmojis   = input.bool(true, "Show Mood Emojis?")
showPanel    = input.bool(true, "Show Status Panel?")

// MACD Params (standard)
macdFast = 12
macdSlow = 26
macdSig  = 9

//──────────────────────────────────────────────
// 📈 CURRENT TF (15M) - Entry Triggers
//──────────────────────────────────────────────
sma20 = ta.sma(close, smaLen)
rsi   = ta.rsi(close, rsiLen)
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSig)
volSMA = ta.sma(volume, volLen)
volRatio = volSMA > 0 ? volume / volSMA : 0.0
steadyVol = volRatio > 1 and volRatio < maxVolMult

// Range for Mood
rangeNow = ta.ema(high - low, rangeLen)
avgRange = ta.sma(rangeNow, rangeLen)
tinyRange = rangeNow < avgRange * 0.8
wideRange = rangeNow > avgRange * 1.2

// Bounce Conditions (15M Entry Zone)
oversoldBounce = ta.crossover(rsi, 30)  // Cross into 30-40 from below
rsiOversoldZone = rsi >= 30 and rsi <= 40
macdShrinkingRed = macdHist < 0 and macdHist > macdHist[1]  // Shrinking red bars
higherLow = low > low[1]
volTickUp = volume > volume[1]
greenBar = close > open
redBar = close < open
higherVolConfirm = volume > volSMA

// Combined Bounce Trigger
bounceTrigger = oversoldBounce or (rsiOversoldZone and macdShrinkingRed and higherLow and volTickUp)

// Volume-Only Cross-Check
volDemand = greenBar and higherVolConfirm  // Real demand
volPressure = redBar and higherVolConfirm  // Real sell pressure
indecision = not higherVolConfirm and not tinyRange  // Low vol + not small candles

//──────────────────────────────────────────────
// 🧭 1H INTERMEDIATE CONFIRMATION
//──────────────────────────────────────────────
htfClose_1h = request.security(syminfo.tickerid, "60", close, lookahead=barmerge.lookahead_off)
sma20_1h = request.security(syminfo.tickerid, "60", ta.sma(close, smaLen), lookahead=barmerge.lookahead_off)
rsi_1h = request.security(syminfo.tickerid, "60", ta.rsi(close, rsiLen), lookahead=barmerge.lookahead_off)
[macdLine_1h, signalLine_1h, macdHist_1h] = request.security(syminfo.tickerid, "60", ta.macd(close, macdFast, macdSlow, macdSig), lookahead=barmerge.lookahead_off)
volRatio_1h = request.security(syminfo.tickerid, "60", volume / ta.sma(volume, volLen), lookahead=barmerge.lookahead_off)
steadyVol_1h = volRatio_1h > 1 and volRatio_1h < maxVolMult

priceBull_1h = htfClose_1h > sma20_1h
priceBear_1h = htfClose_1h < sma20_1h
macdBull_1h = macdLine_1h > signalLine_1h
macdBear_1h = macdLine_1h < signalLine_1h
rsiBull_1h = rsi_1h > 50
rsiBear_1h = rsi_1h < 50

bullConfirm_1h = use1HConfirm ? (macdBull_1h and rsiBull_1h and priceBull_1h and steadyVol_1h) : true
bearConfirm_1h = use1HConfirm ? (macdBear_1h and rsiBear_1h and priceBear_1h and steadyVol_1h) : true

//──────────────────────────────────────────────
// 🧭 4H TOP-DOWN BIAS
//──────────────────────────────────────────────
rsi_4h = request.security(syminfo.tickerid, "240", ta.rsi(close, rsiLen), lookahead=barmerge.lookahead_off)
[macdLine_4h, signalLine_4h, macdHist_4h] = request.security(syminfo.tickerid, "240", ta.macd(close, macdFast, macdSlow, macdSig), lookahead=barmerge.lookahead_off)
volConfirmBull_4h = request.security(syminfo.tickerid, "240", (volume > ta.sma(volume, volLen)) and (close > open), lookahead=barmerge.lookahead_off)
volConfirmBear_4h = request.security(syminfo.tickerid, "240", (volume > ta.sma(volume, volLen)) and (close < open), lookahead=barmerge.lookahead_off)

macdBull_4h = macdHist_4h > 0
macdBear_4h = macdHist_4h < 0
rsiBull_4h = rsi_4h > 55
rsiBear_4h = rsi_4h < 45

bullBias_4h = use4HFilter ? (macdBull_4h and rsiBull_4h and volConfirmBull_4h) : true
bearBias_4h = use4HFilter ? (macdBear_4h and rsiBear_4h and volConfirmBear_4h) : true

//──────────────────────────────────────────────
// ⚡ TRADE SIGNALS (Aligned Flow)
//──────────────────────────────────────────────
// Long: Bull bias + 1H bull confirm + 15M bounce + vol demand
longValid = bullBias_4h and bullConfirm_1h and bounceTrigger and volDemand

// Short: Bear bias + 1H bear confirm + 15M bounce (probe fail) + vol pressure
shortValid = bearBias_4h and bearConfirm_1h and bounceTrigger and volPressure

// Avoid signals in indecision
longValid := longValid and not indecision
shortValid := shortValid and not indecision

//──────────────────────────────────────────────
// 💼 STRATEGY ENTRIES & EXITS
//──────────────────────────────────────────────
// Entries
if longValid
    strategy.entry("Long", strategy.long)

if shortValid
    strategy.entry("Short", strategy.short)

// Exits: Close on opposite signal
if shortValid and strategy.position_size > 0
    strategy.close("Long")

if longValid and strategy.position_size < 0
    strategy.close("Short")

// Optional: Add basic TP/SL (uncomment and adjust)
// strategy.exit("Long TP/SL", "Long", profit=2, loss=1)  // 2:1 RR in %
// strategy.exit("Short TP/SL", "Short", profit=2, loss=1)

//──────────────────────────────────────────────
// 🎨 VISUALS & MOOD
//──────────────────────────────────────────────
// Background Heatmap (T7 Indecision/Confirm)
confirmIndecision = steadyVol and tinyRange  // Low vol + small candles = indecision (anxious wait)
fadeIntensity = math.min(math.max((volRatio - 1) / math.max(maxVolMult - 1, 0.0001), 0), 1)
fadeAlpha = 90 - (fadeIntensity * 70)
bgcolor(confirmIndecision ? color.new(color.yellow, fadeAlpha) : na, title="Indecision Highlight")  // Yellow for wait

// Mood Emojis (Calm/Quiet/Active)
if showEmojis
    if confirmIndecision
        label.new(bar_index, high, "🟡", style=label.style_label_down, color=color.new(color.yellow, 80), textcolor=color.yellow, size=size.tiny)
    else if volRatio < 1 and not tinyRange
        label.new(bar_index, low, "🌿", style=label.style_label_up, color=color.new(color.green, 80), textcolor=color.green, size=size.tiny)
    else if wideRange and volRatio > maxVolMult
        label.new(bar_index, high * 1.01, "🔥", style=label.style_label_down, color=color.new(color.red, 80), textcolor=color.red, size=size.tiny)

// Shapes for Signals
plotshape(longValid, "Long Entry", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortValid, "Short Entry", shape.triangledown, location.abovebar, color.red, size=size.small)

// Plot SMA20
plot(sma20, "20 SMA", color=color.new(color.blue, 0), linewidth=2)

//──────────────────────────────────────────────
// 🧭 STATUS PANEL (Mood & Bias)
//──────────────────────────────────────────────
if showPanel
    var table statusTbl = table.new(position.top_right, 1, 6, bgcolor=color.new(color.black, 80), border_width=1)
    
    // Bias Text
    biasInner = bearBias_4h ? "🔴 Bear Bias" : "⚪ Neutral"
    biasTxt = bullBias_4h ? "🟢 Bull Bias" : biasInner
    
    // Confirm Text
    confirmInner = bearConfirm_1h ? "🔴 1H Bear OK" : "⚪ 1H Neutral"
    confirmTxt = bullConfirm_1h ? "🟢 1H Bull OK" : confirmInner
    
    entryTxt = bounceTrigger ? "📍 Bounce Zone" : "⏳ No Trigger"
    volDesc = higherVolConfirm ? "📈 Vol Up" : "📉 Vol Low"
    rangeDesc = tinyRange ? "tight" : wideRange ? "wide" : "normal"
    
    // Mood Text (flattened nesting)
    calmMood = volRatio < 1 ? "🌿 Calm (Wait Spike)" : na
    activeMood = wideRange ? "🔥 Active (Trade)" : "⚪ Quiet"
    innerMood = na(calmMood) ? activeMood : calmMood
    moodTxt = confirmIndecision ? "🟡 Anxious (Wait)" : innerMood
    
    table.cell(statusTbl, 0, 0, "4H Bias", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 50))
    table.cell(statusTbl, 0, 1, biasTxt, text_color=color.white, text_size=size.small)
    table.cell(statusTbl, 0, 2, "1H Confirm", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 50))
    table.cell(statusTbl, 0, 3, confirmTxt, text_color=color.white, text_size=size.small)
    table.cell(statusTbl, 0, 4, "15M Entry", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 50))
    table.cell(statusTbl, 0, 5, entryTxt + "\n" + moodTxt + "\nVol: " + str.tostring(volRatio, "#.##") + "x | Range: " + rangeDesc, text_color=color.white, text_size=size.small)

//──────────────────────────────────────────────
// 🚨 ALERTS
//──────────────────────────────────────────────
alertcondition(longValid, "T7 Long Signal", "🟢 T7 Aligned: Bull Bias + 1H Confirm + 15M Bounce + Vol Demand")
alertcondition(shortValid, "T7 Short Signal", "🔴 T7 Aligned: Bear Bias + 1H Confirm + 15M Bounce Probe Fail + Vol Pressure")
alertcondition(bounceTrigger, "T7 Bounce Alert", "📍 15M Oversold Bounce Zone - Check Bias for Direction")
